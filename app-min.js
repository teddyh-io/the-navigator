let map,markers={},warehousesData=[],currentBounds=null;function initMap(){map=L.map("map").setView([39.8283,-98.5795],4),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:19}).addTo(map)}function getWarehouseIcon(e="in stock"){let t="#059669";return"low stock"===e?t="#d97706":"out of stock"===e&&(t="#dc2626"),L.divIcon({className:"custom-marker",html:`<div style="\n            background: ${t};\n            width: 32px;\n            height: 32px;\n            border-radius: 50% 50% 50% 0;\n            transform: rotate(-45deg);\n            border: 3px solid white;\n            box-shadow: 0 2px 8px rgba(0,0,0,0.3);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n        ">\n            <span style="\n                color: white;\n                font-size: 16px;\n                transform: rotate(45deg);\n            "></span>\n        </div>`,iconSize:[32,32],iconAnchor:[16,32],popupAnchor:[0,-32]})}function clearMarkers(){Object.values(markers).forEach((e=>map.removeLayer(e))),markers={}}function addMarkers(e){if(clearMarkers(),0===e.length)return;const t=[];e.forEach(((e,n)=>{const{latitude:s,longitude:o}=e.coordinates;t.push([s,o]);const a=L.marker([s,o],{icon:getWarehouseIcon(e.inventoryStatus)}).addTo(map);let r="#059669";"low stock"===e.inventoryStatus?r="#d97706":"out of stock"===e.inventoryStatus&&(r="#dc2626");const i=`https://www.google.com/maps/search/?api=1&query=${s},${o}`,l=`\n            <div class="popup-content">\n                <h3>${e.name}</h3>\n                <p>Status: <span style="color: ${r}; font-weight: 600;">${e.inventoryStatus}</span></p>\n                <p><a href="${i}" target="_blank" style="color: #E32A36; text-decoration: none; font-size: 13px; font-weight: 500;" title="Open in Google Maps">üìç Open in Google Maps</a></p>\n                ${e.phone?`<p style="font-size: 13px; color: #666; margin-top: 8px;">üìû ${e.phone}</p>`:""}\n                <div class="popup-products">\n                    <strong>Products (${e.products.length}):</strong>\n                    ${e.products.map((e=>`\n                        <div class="popup-product">‚Ä¢ ${e.name}</div>\n                    `)).join("")}\n                </div>\n            </div>\n        `;a.bindPopup(l),a.on("click",(()=>{const t=document.querySelector(`[data-warehouse-number="${e.warehouseNumber}"]`);t&&(document.querySelectorAll(".warehouse-card").forEach((e=>e.classList.remove("active"))),t.classList.add("active"),t.scrollIntoView({behavior:"smooth",block:"nearest"}))})),markers[e.warehouseNumber]=a})),t.length>0&&(currentBounds=t,map.fitBounds(t,{padding:[50,50]}))}function highlightWarehouse(e){document.querySelectorAll(".warehouse-card").forEach((e=>{e.classList.remove("active")}));const t=document.querySelector(`[data-warehouse-index="${e}"]`);t&&(t.classList.add("active"),t.scrollIntoView({behavior:"smooth",block:"nearest"}))}function showResults(){document.getElementById("searchScreen").style.display="none",document.getElementById("resultsScreen").style.display="flex",localStorage.setItem("viewingResults","true")}function showSearch(){document.getElementById("searchScreen").style.display="flex",document.getElementById("resultsScreen").style.display="none",localStorage.removeItem("viewingResults")}function displayWarehouses(e){const t=document.getElementById("warehousesList"),n=document.getElementById("noResults"),s=document.getElementById("summary");if(t.innerHTML="",showResults(),!e.warehouses||0===e.warehouses.length)return n.style.display="flex",void(s.textContent="");const o=e.warehouses.filter((e=>"in stock"===e.inventoryStatus||"low stock"===e.inventoryStatus)),a=e.warehouses.filter((e=>"out of stock"===e.inventoryStatus)),r=[...o].sort(((e,t)=>e.distance-t.distance)),i=[...a].sort(((e,t)=>e.distance-t.distance));0===o.length?(n.style.display="none",t.innerHTML='\n            <div class="no-stock-inline">\n                <div class="no-stock-content">\n                    <div class="icon">üòø</div>\n                    <div class="no-stock-text">\n                        <h3>No Stock Available</h3>\n                        <p>There are no warehouses with inventory in your search area. Try increasing your search radius.</p>\n                    </div>\n                </div>\n            </div>\n        ',s.textContent=`Found ${a.length} warehouse${1!==a.length?"s":""} (all out of stock)`):(n.style.display="none",s.textContent=`Found ${o.length} warehouse${1!==o.length?"s":""} with stock`,a.length>0&&(s.textContent+=` and ${a.length} out of stock`));const l=[...r,...i];if(r.forEach(((e,n)=>{const s=createWarehouseCard(e,l.indexOf(e));t.appendChild(s)})),i.length>0){const e=document.createElement("div");e.className="warehouse-divider",e.innerHTML="<span>Out of Stock Locations</span>",t.appendChild(e)}i.forEach(((e,n)=>{const s=createWarehouseCard(e,l.indexOf(e));s.classList.add("out-of-stock-card"),t.appendChild(s)}))}function formatRestockDate(e){const t=new Date(e),n=t.toLocaleString("en-US",{month:"short"}).toUpperCase(),s=t.getDate(),o=t.getHours();let a;return a=o<12?"MORNING":o<17?"MID DAY":"EVENING",{month:n,day:s,timeOfDay:a}}function parseDurationToHours(e){if(!e)return 0;let t=0;const n=e.match(/(\d+)\s+day/),s=e.match(/(\d+)\s+hour/);return n&&(t+=24*parseInt(n[1])),s&&(t+=parseInt(s[1])),t}function calculateTimeInStock(e){const t=new Date(e),n=new Date-t,s=Math.floor(n/36e5),o=Math.floor(s/24),a=s%24;return o>0?`${o} day${1!==o?"s":""}, ${a} hour${1!==a?"s":""}`:`${a} hour${1!==a?"s":""}`}function getCompetitivenessLevel(e){if(!e.historic||!e.historic.latestRestock)return null;let t=0;if("out of stock"===e.inventoryStatus){const n=e.historic.durationInStock;return n?(t=parseDurationToHours(n),t<24?"highly-competitive":t<48?"competitive":"less-competitive"):null}{if(!e.historic.durationInStock)return null;const n=new Date(e.historic.latestRestock);return t=(new Date-n)/36e5,t<36?"competitive":"less-competitive"}}function createRestockIQWidget(e){if(!e.historic||!e.historic.latestRestock)return"";const t=new Date(e.historic.latestRestock),n=new Date;if(Math.abs((n-t)/1e3)<60)return"";const s=getCompetitivenessLevel(e);if(!s)return"";const{month:o,day:a,timeOfDay:r}=formatRestockDate(e.historic.latestRestock),i="out of stock"===e.inventoryStatus;let l="",c="",d="";if("highly-competitive"===s?(l="badge-highly-competitive",c="HIGHLY COMPETITIVE"):"competitive"===s?(l="badge-competitive",c="COMPETITIVE"):(l="badge-less-competitive",c="LESS COMPETITIVE"),i&&e.historic.becameOutOfStock){const t=formatRestockDate(e.historic.becameOutOfStock);d=`\n            <div class="restock-section out-section">\n                <div class="restock-label">OUT OF STOCK</div>\n                <div class="restock-circle"></div>\n                <div class="restock-date">${t.month} ${t.day}</div>\n                <div class="restock-time">${t.timeOfDay}</div>\n            </div>\n        `}else{let t,n;e.historic.durationInStock?(t=e.historic.durationInStock.replace(" and ",",").toUpperCase(),n="STOCK USUALLY LASTS FOR"):(t=calculateTimeInStock(e.historic.latestRestock).toUpperCase(),n="IN STOCK FOR");d=`\n            <div class="restock-section duration-section">\n                <div class="restock-label">${n}</div>\n                <div class="restock-duration">${t.replace(", ","<br>")}</div>\n            </div>\n        `}let u="";return i&&e.historic.durationInStock&&(u=`\n            <div class="restock-timeline-duration">\n                <div class="timeline-label">IN STOCK FOR</div>\n                <div class="timeline-value">${e.historic.durationInStock.replace(" and ",", ").toUpperCase()}</div>\n            </div>\n        `),`\n        <div class="restock-iq-widget ${i?"out-of-stock-widget":"in-stock-widget"}">\n            <div class="restock-header">\n                <div class="restock-brand">\n                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">\n                        <path d="M13 2L3 14h8l-1 8 10-12h-8l1-8z"/>\n                    </svg>\n                    <span>restockIQ</span>\n                </div>\n                <div class="restock-badge ${l}">${c}</div>\n            </div>\n            <div class="restock-content">\n                <div class="restock-section">\n                    <div class="restock-label">FIRST SEEN</div>\n                    <div class="restock-circle"></div>\n                    <div class="restock-date">${o} ${a}</div>\n                    <div class="restock-time">${r}</div>\n                </div>\n                ${u}\n                ${d}\n            </div>\n        </div>\n    `}function createWarehouseCard(e,t){const n=document.createElement("div");n.className="warehouse-card",n.setAttribute("data-warehouse-index",t),n.setAttribute("data-warehouse-number",e.warehouseNumber);const{latitude:s,longitude:o}=e.coordinates,a=`https://www.google.com/maps/search/?api=1&query=${s},${o}`,r=e.phone?`tel:${e.phone.replace(/\D/g,"")}`:"#",i=createRestockIQWidget(e);return n.innerHTML=`\n        <div class="warehouse-header">\n            <div class="warehouse-info">\n                <div class="warehouse-name">${e.name}</div>\n                <div class="warehouse-distance-label">${e.distance.toFixed(1)} mi</div>\n            </div>\n            <div class="warehouse-actions">\n                <a href="${a}" target="_blank" class="icon-btn" title="Open in Google Maps">\n                    <i class="fas fa-directions"></i>\n                </a>\n                <a href="${r}" class="icon-btn" title="Call ${e.phone||"Warehouse"}">\n                    <i class="fas fa-phone"></i>\n                </a>\n            </div>\n        </div>\n        <div class="products-list">\n            ${e.products.map((e=>{let t="in-stock";return"low stock"===e.stockStatus?t="low-stock":"out of stock"===e.stockStatus&&(t="out-of-stock"),`\n                    <div class="product-item">\n                        <div class="product-name">${e.name}</div>\n                        <div class="product-details">\n                            <span class="product-number">Item #${e.itemNumber}</span>\n                            <span class="stock-badge ${t}">\n                                ${e.stockStatus}\n                            </span>\n                        </div>\n                    </div>\n                `})).join("")}\n        </div>\n        ${i}\n    `,n.addEventListener("click",(()=>{highlightWarehouse(t);const n=markers[e.warehouseNumber];if(n&&(n.openPopup(),window.innerWidth<=1024)){const e=document.querySelector('.tab-btn[data-tab="map"]');e&&e.click()}})),n}async function verifyUser(e){const t=`https://eoan0uckz3ul617.m.pipedream.net?user=${encodeURIComponent(e)}`;try{const e=await fetch(t,{method:"GET",headers:{Authorization:"Bearer kirkland"}});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return await e.json()}catch(e){throw console.error("Error verifying user:",e),e}}async function fetchInventory(e,t,n){const s=`https://eow4gra92oz16n8.m.pipedream.net?radius=${n}&user=${encodeURIComponent(e)}&zip=${t}`;try{const e=await fetch(s,{method:"GET",headers:{Authorization:"Bearer kirkland"}});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return await e.json()}catch(e){throw console.error("Error fetching inventory:",e),e}}let userData=null,isAuthenticated=!1;function saveSearchResults(e,t,n,s){const o={data:e,email:t,zip:n,radius:s,timestamp:(new Date).toISOString()};localStorage.setItem("lastSearchResults",JSON.stringify(o))}function loadSavedSearchResults(){const e=localStorage.getItem("lastSearchResults");if(!e)return null;try{return JSON.parse(e)}catch(e){return console.error("Error parsing saved search results:",e),null}}function restoreLastSearchResults(){const e=loadSavedSearchResults();if(!e)return void alert("No previous search results found.");warehousesData=e.data.warehouses||[],displayWarehouses(e.data);addMarkers(warehousesData.filter((e=>"in stock"===e.inventoryStatus||"low stock"===e.inventoryStatus)).sort(((e,t)=>e.distance-t.distance)))}function populateZipDatalist(e){const t=document.getElementById("zipCodes"),n=document.getElementById("zipInput"),s=document.getElementById("zipCount");t.innerHTML="";const o=e.zip&&Array.isArray(e.zip)&&e.zip.length>0&&""!==e.zip[0];o?(e.zip.forEach((e=>{if(e){const n=document.createElement("option");n.value=e,t.appendChild(n)}})),n.value=e.zip[0]):n.value="";const a=o?e.zip.filter((e=>e)).length:0;e.maxZipsAllowed&&(s.textContent=`${a} of ${e.maxZipsAllowed} slots remaining`,a>=e.maxZipsAllowed?(s.style.color="#d97706",n.placeholder="Select from your saved ZIP codes"):(s.style.color="#999",n.placeholder="Select or enter new ZIP code")),updateSearchesRemaining(e.searchesRemaining)}function updateReloadLinkVisibility(){const e=document.getElementById("reloadLastSearchLink");if(e){const t=loadSavedSearchResults();e.style.display=t?"block":"none"}}function updateSearchesRemaining(e){const t=document.getElementById("searchesRemaining"),n=document.getElementById("searchesRemainingText"),s=document.querySelector(".search-btn");null!=e&&(t.style.display="block",0===e?(n.textContent="No searches remaining",t.className="searches-remaining error",s.disabled=!0):1===e?(n.textContent="1 search remaining",t.className="searches-remaining warning",s.disabled=!1):e<=3?(n.textContent=`${e} searches remaining`,t.className="searches-remaining warning",s.disabled=!1):(n.textContent=`${e} searches remaining`,t.className="searches-remaining",s.disabled=!1)),updateReloadLinkVisibility()}function showSearchOptions(){const e=document.getElementById("searchOptions"),t=document.getElementById("emailGroup"),n=document.getElementById("submitBtnText"),s=document.getElementById("zipInput"),o=document.getElementById("subscriptionBox");t.style.display="none",o&&(o.style.display="none"),e.style.display="block",setTimeout((()=>{e.style.opacity="1",e.style.transform="translateY(0)"}),10),s.required=!0,n.textContent="Search Warehouses",userData&&void 0!==userData.searchesRemaining&&updateSearchesRemaining(userData.searchesRemaining),updateReloadLinkVisibility()}function resetToEmailInput(){const e=document.getElementById("searchOptions"),t=document.getElementById("emailGroup"),n=document.getElementById("submitBtnText"),s=document.getElementById("returningUserBanner"),o=document.getElementById("zipInput"),a=document.getElementById("searchesRemaining"),r=document.querySelector(".search-btn");e.style.display="none",e.style.opacity="0",e.style.transform="translateY(-20px)",o.required=!1,t.style.display="block",n.textContent="Next",s.style.display="none";const i=document.getElementById("subscriptionBox");i&&(i.style.display="block"),a.style.display="none",r.disabled=!1,isAuthenticated=!1,userData=null,localStorage.removeItem("userEmail"),document.getElementById("userEmail").value=""}document.getElementById("notYouLink").addEventListener("click",(e=>{e.preventDefault(),resetToEmailInput()})),document.getElementById("searchForm").addEventListener("submit",(async e=>{e.preventDefault();const t=e.target.querySelector(".search-btn"),n=t.querySelector(".btn-text"),s=t.querySelector(".loader");if(!isAuthenticated){const e=document.getElementById("userEmail").value.trim();if(!e)return void alert("Please enter your email address.");t.disabled=!0,s.style.display="block";try{const t=await verifyUser(e);if(t.success){userData=t,isAuthenticated=!0,populateZipDatalist(t),localStorage.setItem("userEmail",e);const n=document.getElementById("returningUserBanner"),s=document.getElementById("returningUserText"),o=document.getElementById("planPill");n&&s&&(s.querySelector("strong").textContent=e,o&&t.plan&&(o.textContent=t.plan,o.className="plan-pill "+t.plan.toLowerCase()),n.style.display="flex"),showSearchOptions()}else alert("Invalid email or subscription not found. Please check your subscription status.")}catch(e){alert("Error verifying user. Check if you are subscribed and that your email is correct."),console.error(e)}finally{t.disabled=!1,s.style.display="none"}return}const o=document.getElementById("userEmail").value.trim(),a=document.getElementById("zipInput"),r=document.getElementById("radius").value,i=a.value.trim();if(!userData)return void alert("Please wait a moment while we verify your account...");if(void 0!==userData.searchesRemaining&&0===userData.searchesRemaining)return void alert("You have no searches remaining. Please contact support.");if(!i)return void alert("Please enter a ZIP code.");if(5!==i.length||!/^\d{5}$/.test(i))return void alert("Please enter a valid 5-digit ZIP code.");const l=!userData.zip||!userData.zip.includes(i),c=userData.zip&&Array.isArray(userData.zip)&&userData.zip.length>0&&""!==userData.zip[0]?userData.zip.filter((e=>e)).length:0;if(l&&userData.maxZipsAllowed&&c>=userData.maxZipsAllowed)alert(`You've reached the maximum of ${userData.maxZipsAllowed} ZIP codes. Please use one of your saved ZIP codes or contact support.`);else{t.disabled=!0,n.textContent="Searching...",s.style.display="block";try{const e=await fetchInventory(o,i,r);warehousesData=e.warehouses||[],saveSearchResults(e,o,i,r),displayWarehouses(e);const t=warehousesData.filter((e=>"in stock"===e.inventoryStatus||"low stock"===e.inventoryStatus));addMarkers(t.sort(((e,t)=>e.distance-t.distance)));try{const e=await verifyUser(o);e.success&&(userData=e,populateZipDatalist(e),a.value=i,updateSearchesRemaining(e.searchesRemaining))}catch(e){console.error("Error refreshing user data:",e)}}catch(e){alert("Error fetching inventory. Please try again."),console.error(e)}finally{t.disabled=!1,n.textContent="Search Warehouses",s.style.display="none"}}}));const radiusSlider=document.getElementById("radius"),radiusValue=document.getElementById("radiusValue");radiusSlider.addEventListener("input",(e=>{const t=e.target.value;radiusValue.textContent=t;const n=(t-radiusSlider.min)/(radiusSlider.max-radiusSlider.min)*100;radiusSlider.style.setProperty("--slider-percent",`${n}%`)}));const initialPercent=(radiusSlider.value-radiusSlider.min)/(radiusSlider.max-radiusSlider.min)*100;function setupMobileTabs(){const e=document.querySelectorAll(".tab-btn");e.forEach((t=>{t.addEventListener("click",(()=>{const n=t.getAttribute("data-tab");e.forEach((e=>e.classList.remove("active"))),t.classList.add("active"),"map"===n?(document.body.classList.remove("list-active"),document.body.classList.add("map-active"),setTimeout((()=>{map&&(map.invalidateSize(),currentBounds&&currentBounds.length>0&&map.fitBounds(currentBounds,{padding:[50,50]}))}),100)):(document.body.classList.remove("map-active"),document.body.classList.add("list-active"))}))}))}function generateKML(e){if(!e||0===e.length)return null;const t=e.filter((e=>"in stock"===e.inventoryStatus||"low stock"===e.inventoryStatus));if(0===t.length)return null;let n="";t.forEach((e=>{const{latitude:t,longitude:s}=e.coordinates;let o="inStockIcon";"low stock"===e.inventoryStatus&&(o="lowStockIcon");let a=`<![CDATA[\n            <p><strong>Status:</strong> ${e.inventoryStatus}</p>\n            ${e.phone?`<p><strong>Phone:</strong> ${e.phone}</p>`:""}\n            <p><strong>Products (${e.products.length}):</strong></p>\n            <ul>\n                ${e.products.map((e=>`<li>${e.name} - Item #${e.itemNumber} (${e.stockStatus})</li>`)).join("")}\n            </ul>\n        ]]>`;n+=`\n    <Placemark>\n      <name>${e.name}</name>\n      <description>${a}</description>\n      <styleUrl>#${o}</styleUrl>\n      <Point>\n        <coordinates>${s},${t},0</coordinates>\n      </Point>\n    </Placemark>`}));return'<?xml version="1.0" encoding="UTF-8"?>\n<kml xmlns="http://www.opengis.net/kml/2.2">\n  <Document>\n    <name>Costco Warehouses Inventory</name>\n    <description>Available inventory locations</description>\n    <Style id="inStockIcon">\n      <IconStyle>\n        <color>ff059669</color>\n        <scale>1.2</scale>\n        <Icon>\n          <href>http://maps.google.com/mapfiles/kml/paddle/grn-circle.png</href>\n        </Icon>\n      </IconStyle>\n    </Style>\n    <Style id="lowStockIcon">\n      <IconStyle>\n        <color>ff06d997</color>\n        <scale>1.2</scale>\n        <Icon>\n          <href>http://maps.google.com/mapfiles/kml/paddle/ylw-circle.png</href>\n        </Icon>\n      </IconStyle>\n    </Style>\n'+n+"\n  </Document>\n</kml>"}function downloadKML(){if(!warehousesData||0===warehousesData.length)return void alert("No warehouse data available to export.");const e=generateKML(warehousesData);if(!e)return void alert("Failed to generate KML file.");const t=new Blob([e],{type:"application/vnd.google-earth.kml+xml"}),n=URL.createObjectURL(t),s=document.createElement("a");s.href=n,s.download=`costco-inventory-${(new Date).toISOString().split("T")[0]}.kml`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n)}function checkAndRestoreResults(){if("true"===localStorage.getItem("viewingResults")){loadSavedSearchResults()?restoreLastSearchResults():localStorage.removeItem("viewingResults")}}function openAlertsModal(){const e=document.getElementById("alertsModal");if(e){e.style.display="flex";const t=document.getElementById("alertsMessage");t&&(t.style.display="none",t.textContent=""),document.getElementById("alertsForm").reset(),document.getElementById("alertRadiusValue").textContent="100"}}function closeAlertsModal(){const e=document.getElementById("alertsModal");e&&(e.style.display="none")}async function setupAlert(e,t,n){try{const s=await fetch("https://eojb17xh1ydl2zz.m.pipedream.net",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer kirkland"},body:JSON.stringify({user:e,zip:t,radius:n})}),o=s.headers.get("content-type");if(o&&o.includes("application/json")){const e=await s.json();return{httpStatus:s.status,...e}}{const e=await s.text();return console.error("Non-JSON response:",e),{httpStatus:s.status,status:s.status,body:e,error:!0}}}catch(e){throw console.error("Error setting up alert:",e),e}}radiusSlider.style.setProperty("--slider-percent",`${initialPercent}%`),document.getElementById("backBtn").addEventListener("click",(()=>{showSearch(),isAuthenticated&&showSearchOptions()})),document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("reloadSearchBtn");e&&e.addEventListener("click",(e=>{e.preventDefault(),restoreLastSearchResults()}))})),window.addEventListener("load",(async()=>{initMap(),setupMobileTabs(),document.body.classList.add("list-active");const e=document.getElementById("reloadLastSearchLink");e&&(e.style.display="none");const t=localStorage.getItem("userEmail");if(t){document.getElementById("userEmail").value=t;const e=document.getElementById("returningUserBanner"),n=document.getElementById("returningUserText");document.getElementById("planPill");n.querySelector("strong").textContent=t,e.style.display="flex";const s=document.getElementById("subscriptionBox");s&&(s.style.display="none"),isAuthenticated=!0,showSearchOptions();document.getElementById("zipCount").innerHTML='<span style="color: #999;">Loading your saved ZIP codes...</span>',verifyUser(t).then((e=>{if(e.success){userData=e,populateZipDatalist(e);const t=document.getElementById("planPill");t&&e.plan&&(t.textContent=e.plan,t.className="plan-pill "+e.plan.toLowerCase())}else resetToEmailInput(),alert("Your session has expired. Please log in again.")})).catch((e=>{console.error("Error verifying saved email:",e),resetToEmailInput(),alert("Error verifying your account. Please log in again.")}))}const n=document.getElementById("downloadKmlBtn");n&&n.addEventListener("click",(e=>{e.stopPropagation(),downloadKML()}));const s=document.getElementById("alertsLink");s&&s.addEventListener("click",(e=>{e.preventDefault(),openAlertsModal()}));const o=document.getElementById("closeAlertsModal");o&&o.addEventListener("click",closeAlertsModal);const a=document.getElementById("alertsModal");a&&a.addEventListener("click",(e=>{e.target===a&&closeAlertsModal()}));const r=document.getElementById("alertsForm");r&&r.addEventListener("submit",(async e=>{e.preventDefault();const t=e.target.querySelector(".alert-btn"),n=t.querySelector(".btn-text"),s=t.querySelector(".loader"),o=document.getElementById("alertsMessage"),a=document.getElementById("alertZipInput").value.trim(),r=document.getElementById("alertRadius").value,i=document.getElementById("userEmail").value.trim();if(!a||5!==a.length||!/^\d{5}$/.test(a))return o.textContent="Please enter a valid 5-digit ZIP code.",o.className="alerts-message error",void(o.style.display="block");t.disabled=!0,n.textContent="Setting up...",s.style.display="block",o.style.display="none";try{const e=await setupAlert(i,a,r);if((200===e.httpStatus||200===e.status)&&!0===e.success&&!e.error)o.textContent=`Success! You'll receive alerts for ZIP ${a} within ${r} miles.`,o.className="alerts-message success",o.style.display="block",setTimeout((()=>{closeAlertsModal()}),2e3);else{let t="Failed to setup alert. Please try again.";e.error&&e.body&&(t="string"==typeof e.body?e.body:JSON.stringify(e.body)),o.textContent=t,o.className="alerts-message error",o.style.display="block"}}catch(e){o.textContent="Error setting up alert. Please try again.",o.className="alerts-message error",o.style.display="block",console.error(e)}finally{t.disabled=!1,n.textContent="Setup Autocheck",s.style.display="none"}}));const i=document.getElementById("alertRadius"),l=document.getElementById("alertRadiusValue");if(i&&l){i.addEventListener("input",(e=>{const t=e.target.value;l.textContent=t;const n=(t-i.min)/(i.max-i.min)*100;i.style.setProperty("--slider-percent",`${n}%`)}));const e=(i.value-i.min)/(i.max-i.min)*100;i.style.setProperty("--slider-percent",`${e}%`)}setTimeout((()=>{checkAndRestoreResults()}),100)}));